<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLAR RM PRO - OFICIAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --blue: #2240db; --dark: #0b0b0b; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333; max-width: 400px; margin: 0 auto; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        .btn { background: var(--blue); color: white; padding: 15px; border: none; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        
        /* Area invisible para captura */
        #capture-area { 
            position: absolute; left: -9999px; top: 0;
            background: #fff; color: #000; width: 1000px; padding: 40px; border: 5px solid #000;
        }
        .plano-box { border: 2px solid #000; padding: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h2>SOLAR RM PRO</h2>
    <p style="font-size: 12px; color: #fbc02d;">GENERADOR DE INGENIERÍA NOM</p>
    <input type="text" id="cliente" placeholder="Nombre del Proyecto">
    <input type="number" id="kw" placeholder="Potencia Total kW (AC)">
    <select id="red">
        <option value="220">Red CFE 220V (Trifásico)</option>
        <option value="440">Red CFE 440V (Industrial)</option>
        <option value="127">Red CFE 127V (Monofásico)</option>
    </select>
    <button class="btn" onclick="procesar()">GENERAR Y ENVIAR</button>
</div>

<div id="capture-area">
    <div class="plano-box">
        <h1 id="out-titulo">DIAGRAMA UNIFILAR - SOLAR RM</h1>
        <hr>
        <p><b>PROYECTO:</b> <span id="out-cliente"></span></p>
        <div style="height: 100px; border: 2px solid #000; margin: 20px 0; display: flex; align-items: center; justify-content: center;">
            INVERSOR INTERACTIVO <span id="out-pot"></span> kW
        </div>
        <p><b>PROTECCIÓN PRINCIPAL:</b> <span id="out-itm"></span>A</p>
        <p><b>TENSIÓN:</b> <span id="out-v"></span>V</p>
        <hr>
        <p style="font-size: 10px;">DISEÑO SEGÚN NOM-001-SEDE-2012 / ART 690 Y 705</p>
    </div>
</div>

<script>
function procesar() {
    const cliente = document.getElementById('cliente').value || "PROYECTO SOLAR";
    const kw = document.getElementById('kw').value || "5";
    const v = document.getElementById('red').value;
    
    // Cálculos rápidos
    const polos = v == "127" ? 1 : 3;
    const amp = Math.ceil((kw * 1000) / (v * (polos == 3 ? 1.732 : 1) * 0.95) * 1.25);
    
    document.getElementById('out-cliente').innerText = cliente;
    document.getElementById('out-pot').innerText = kw;
    document.getElementById('out-v').innerText = v;
    document.getElementById('out-itm').innerText = amp;

    const area = document.getElementById('capture-area');
    
    html2canvas(area).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg');
        
        // TRUCO FINAL: En lugar de descargar, abrimos una ventana limpia
        // Esto NO saca al usuario de la app porque es una ventana nueva del sistema
        const nuevaVentana = window.open("");
        nuevaVentana.document.write(`
            <html>
            <body style="margin:0; text-align:center; font-family:sans-serif; background:#000; color:#fff;">
                <h3>PLANO GENERADO</h3>
                <p>1. Mantén presionada la imagen para Guardar</p>
                <img src="${imgData}" style="width:100%; border:2px solid #fff;">
                <br><br>
                <button onclick="window.location.href='https://wa.me/?text=Plano%20Listo%20Proyecto%20${cliente}'" 
                        style="padding:15px; background:#25D366; color:#fff; border:none; border-radius:10px; width:80%; font-weight:bold;">
                    COMPARTIR POR WHATSAPP
                </button>
            </body>
            </html>
        `);
    });
}
</script>
</body>
</html>
