<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA DE INGENIER√çA VIP</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FFD700; --bg: #0b0b0b; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
        
        .app-header { background: #000; padding: 15px; text-align: center; border-bottom: 3px solid var(--primary); }
        
        #form-container { padding: 20px; max-width: 600px; margin: 20px auto; background: #111; border-radius: 12px; border: 1px solid #333; box-sizing: border-box; }
        
        .logo-upload { border: 2px dashed #444; padding: 15px; text-align: center; margin-bottom: 15px; border-radius: 8px; cursor: pointer; }
        .logo-preview-thumb { max-height: 40px; display: none; margin: 5px auto; }

        label { font-size: 10px; color: var(--primary); text-transform: uppercase; font-weight: 700; display: block; margin-top: 12px; }
        input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #fff; margin-top: 5px; box-sizing: border-box; }
        
        .btn-vip { background: var(--primary); color: #000; width: 100%; padding: 18px; border: none; border-radius: 10px; font-weight: 900; font-size: 16px; cursor: pointer; margin-top: 20px; }

        /* VISTA DEL PLANO */
        #plano-view { display: none; background: #222; min-height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        #capture-area { 
            background: #fff; color: #000; width: 1050px; padding: 30px; 
            border: 3px solid #000; position: absolute; left: 50%; top: 10px;
            transform-origin: top center; box-sizing: border-box;
        }

        .header-table { width: 100%; border: 3px solid #000; border-collapse: collapse; margin-bottom: 15px; }
        .header-table td { border: 1.5px solid #000; padding: 6px; font-size: 12px; }

        .diagrama-container { display: flex; flex-direction: column; align-items: center; margin: 15px 0; }
        .simbolo { border: 2.5px solid #000; padding: 8px; text-align: center; font-weight: bold; min-width: 180px; font-size: 11px; background: white; }
        .linea-v { width: 2.5px; height: 30px; background: #000; position: relative; }
        .espec-cable { position: absolute; left: 15px; top: 5px; font-size: 10px; font-family: 'Roboto Mono'; width: 450px; text-align: left; font-weight: bold; }
        
        .inv-box { width: 60px; height: 60px; border: 2.5px solid #000; display: flex; align-items: center; justify-content: center; position: relative; font-weight: bold; }
        .inv-box::after { content: ''; position: absolute; width: 85px; height: 2.5px; background: #000; transform: rotate(45deg); }
        .medidor { width: 50px; height: 50px; border: 2.5px solid #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        
        .table-specs { width: 100%; border-collapse: collapse; margin-top: 10px; font-family: 'Roboto Mono'; font-size: 11px; }
        .table-specs td { border: 2px solid #000; padding: 8px; }

        .footer-plano { margin-top: 15px; display: grid; grid-template-columns: 2fr 1fr; gap: 15px; border-top: 3px solid #000; padding-top: 10px; }
        .cuadro-firmas { border: 2.5px solid #000; height: 90px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 5px; font-size: 11px; font-weight: bold; }

        .controls { position: fixed; bottom: 15px; left: 0; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 9999; }
        .btn-f { padding: 12px 20px; border-radius: 50px; border: none; color: #fff; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-header"><h1>INGENIER√çA <span style="color:var(--primary)">VIP</span></h1></div>

<div id="form-container">
    <label>Nombre de tu Compa√±√≠a</label>
    <input type="text" id="nombre_empresa" placeholder="Ej. Solar Energy MX">

    <div class="logo-upload" onclick="document.getElementById('logo-input').click()">
        <span id="upload-text">üìÅ Toca para subir tu LOGO</span>
        <input type="file" id="logo-input" hidden accept="image/*" onchange="previewLogo(this)">
        <img id="logo-preview" class="logo-preview-thumb">
    </div>

    <label>Nombre del Cliente</label><input type="text" id="cliente" placeholder="Nombre del Cliente">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <label>Potencia TOTAL (kW)</label>
            <input type="number" id="potencia_total" value="10" step="0.1">
        </div>
        <div>
            <label>Capacidad x Inversor (kW)</label>
            <input type="number" id="cap_inv" value="5" step="0.1" placeholder="Ej: 5 o 7.6">
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
            <label>Watts por Panel</label>
            <select id="panel_watts">
                <option value="450">450W</option>
                <option value="500">500W</option>
                <option value="550" selected>550W</option>
                <option value="580">580W</option>
                <option value="600">600W</option>
                <option value="660">660W</option>
            </select>
        </div>
        <div>
            <label>Red El√©ctrica</label>
            <select id="red">
                <option value="127">1F-127V</option>
                <option value="220-2" selected>2F-220V</option>
                <option value="220-3">3F-220V</option>
            </select>
        </div>
    </div>

    <label>RPU CFE</label><input type="text" id="rpu" maxlength="12" placeholder="12 d√≠gitos">
    <label>Responsable T√©cnico</label><input type="text" id="responsable" placeholder="Tu nombre">

    <button class="btn-vip" onclick="generarVip()">GENERAR PLANO Y CALCULAR</button>
</div>

<div id="plano-view">
    <div id="capture-area">
        <table class="header-table">
            <tr>
                <td rowspan="2" style="width:180px; text-align:center;">
                    <img id="plano-logo-img" style="max-height:45px; margin-bottom:5px;"><br>
                    <b id="plano-empresa-txt" style="font-size:12px; text-transform:uppercase;"></b>
                </td>
                <td colspan="2"><b>PROYECTO:</b> SISTEMA FOTOVOLTAICO INTERCONECTADO (SFVI)</td>
                <td><b>PLANO:</b> DU-01</td>
            </tr>
            <tr>
                <td><b>CLIENTE:</b> <span id="out-cliente"></span></td>
                <td><b>RPU:</b> <span id="out-rpu"></span></td>
                <td><b>FECHA:</b> <span id="out-fecha"></span></td>
            </tr>
        </table>

        <div class="diagrama-container">
            <div class="simbolo">GENERADOR FV: <span id="out-txt-paneles"></span></div>
            <div class="linea-v"><div class="espec-cable">CABLE SOLAR 10 AWG (1000V) | TUB. PG 1/2"</div></div>
            <div class="simbolo">DESCONECTADOR DC / SUPRESOR PICOS</div>
            <div class="linea-v"></div>
            <div class="inv-box">INV</div>
            <div style="font-size:11px; font-weight:bold; margin-top:5px; text-align:center;">
                <span id="out-num-inv"></span> INVERSOR(ES) DE <span id="out-cap-inv"></span> kW<br>
                CAPACIDAD TOTAL AC: <span id="out-pot-total"></span> kW
            </div>
            <div class="linea-v"><div class="espec-cable" id="out-cable-ac"></div></div>
            <div class="simbolo">PROT. AC: <span id="out-itm"></span>A - <span id="out-polos"></span>P</div>
            <div class="linea-v"><div class="espec-cable" id="out-cable-med"></div></div>
            <div class="medidor">kWh</div>
            <div class="linea-v"></div>
            <div class="simbolo" style="border:3.5px solid #000; padding:12px; font-size:13px;">ACOMETIDA RED EL√âCTRICA (CFE)</div>
        </div>

        <table class="table-specs">
            <tr style="background:#eee;"><th>ESPECIFICACIONES DC</th><th>ESPECIFICACIONES AC</th><th>NORMATIVA</th></tr>
            <tr>
                <td>P. INSTALADA DC: <span id="t-p-dc"></span><br>M√ìDULOS: <span id="t-modulos"></span></td>
                <td>P. NOMINAL AC: <span id="t-p-ac"></span> kW<br>V. NOMINAL: <span id="t-v-ac"></span>V | In: <span id="t-i-ac"></span>A</td>
                <td>NOM-001-SEDE-2012 / Art. 690<br>ESPECIFICACI√ìN CFE G0100-04</td>
            </tr>
        </table>

        <div class="footer-plano">
            <div style="font-size:10px; line-height:1.3;">
                <b>NOTAS T√âCNICAS:</b><br>
                1. Canalizaci√≥n conduit pared gruesa o galvanizada.<br>
                2. Conductores de cobre tipo THWN-2 75¬∞C.<br>
                3. Puesta a tierra con electrodo 5/8" x 1.5m.<br>
                4. Protecci√≥n anti-isla integrada seg√∫n est√°ndar IEEE 1547.
            </div>
            <div class="cuadro-firmas">
                <div style="width:80%; border-top:1.5px solid #000; text-align:center;">
                    <span id="out-firma"></span><br>RESPONSABLE T√âCNICO
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-f" style="background:#444;" onclick="regresar()">EDITAR DATOS</button>
        <button class="btn-f" style="background:#2196F3;" onclick="window.print()">GUARDAR PLANO (PDF)</button>
    </div>
</div>

<script>
let logoBase64 = localStorage.getItem('vip_logo') || "";

window.onload = function() {
    if(logoBase64) {
        document.getElementById('logo-preview').src = logoBase64;
        document.getElementById('logo-preview').style.display = 'block';
        document.getElementById('upload-text').style.display = 'none';
    }
    document.getElementById('nombre_empresa').value = localStorage.getItem('vip_empresa') || "";
    document.getElementById('responsable').value = localStorage.getItem('vip_resp') || "";
}

function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            logoBase64 = e.target.result;
            localStorage.setItem('vip_logo', logoBase64);
            document.getElementById('logo-preview').src = logoBase64;
            document.getElementById('logo-preview').style.display = 'block';
            document.getElementById('upload-text').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function generarVip() {
    const pTotal = parseFloat(document.getElementById('potencia_total').value) || 0;
    const cInv = parseFloat(document.getElementById('cap_inv').value) || 1;
    const wPanel = parseInt(document.getElementById('panel_watts').value);
    const redVal = document.getElementById('red').value;
    
    // Guardar en cache local
    localStorage.setItem('vip_empresa', document.getElementById('nombre_empresa').value);
    localStorage.setItem('vip_resp', document.getElementById('responsable').value);

    // C√°lculos Autom√°ticos
    const numInversores = Math.ceil(pTotal / cInv);
    // Calculamos paneles: Potencia Total * 1.18 (oversize) dividido entre watts del panel
    const numPaneles = Math.ceil((pTotal * 1180) / wPanel); 
    const potRealDC = (numPaneles * wPanel) / 1000;
    
    const v_nom = redVal.split('-')[0];
    const polos = redVal === '127' ? 1 : (redVal === '220-2' ? 2 : 3);
    const ampTotal = (pTotal * 1000) / (v_nom * (polos === 3 ? 1.732 : 1) * 0.95);
    
    // Selecci√≥n de protecci√≥n autom√°tica
    const itm = [15,20,30,40,50,60,70,80,100,125,150,200,225,250].find(x => x >= ampTotal * 1.25) || 250;
    
    // Selecci√≥n de calibre (Simplificado para cobre THWN-2)
    let calibre = "10";
    if(itm > 30) calibre = "8";
    if(itm > 50) calibre = "6";
    if(itm > 65) calibre = "4";
    if(itm > 85) calibre = "2";
    if(itm > 115) calibre = "1/0";

    // Llenar el Plano
    document.getElementById('plano-empresa-txt').innerText = document.getElementById('nombre_empresa').value || "MI EMPRESA";
    document.getElementById('out-cliente').innerText = document.getElementById('cliente').value.toUpperCase();
    document.getElementById('out-rpu').innerText = document.getElementById('rpu').value;
    document.getElementById('out-fecha').innerText = new Date().toLocaleDateString();
    
    document.getElementById('out-txt-paneles').innerText = `${numPaneles} M√ìDULOS DE ${wPanel}W`;
    document.getElementById('out-num-inv').innerText = numInversores;
    document.getElementById('out-cap-inv').innerText = cInv;
    document.getElementById('out-pot-total').innerText = pTotal;
    
    document.getElementById('out-itm').innerText = itm;
    document.getElementById('out-polos').innerText = polos;
    document.getElementById('out-firma').innerText = document.getElementById('responsable').value.toUpperCase();

    document.getElementById('t-p-dc').innerText = potRealDC.toFixed(2) + " kWp";
    document.getElementById('t-modulos').innerText = numPaneles + " pzas";
    document.getElementById('t-p-ac').innerText = pTotal;
    document.getElementById('t-v-ac').innerText = v_nom;
    document.getElementById('t-i-ac').innerText = ampTotal.toFixed(2);

    const txtCable = `${polos + 1} - ${calibre} AWG + 1 - ${calibre} T | TUB. PG ${itm > 30 ? '3/4"' : '1/2"'}`;
    document.getElementById('out-cable-ac').innerText = txtCable;
    document.getElementById('out-cable-med').innerText = txtCable;

    if(logoBase64) document.getElementById('plano-logo-img').src = logoBase64;

    document.getElementById('form-container').style.display = 'none';
    document.getElementById('plano-view').style.display = 'block';
    setTimeout(ajustarEscala, 300);
}

function ajustarEscala() {
    const area = document.getElementById('capture-area');
    const escala = (window.innerWidth - 20) / 1050;
    area.style.transform = `translateX(-50%) scale(${escala < 1 ? escala : 1})`;
}

function regresar() {
    document.getElementById('form-container').style.display = 'block';
    document.getElementById('plano-view').style.display = 'none';
}

window.onresize = ajustarEscala;
</script>
</body>
</html>
